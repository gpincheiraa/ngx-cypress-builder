"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const url = require("url");
var CypressRunningMode;
(function (CypressRunningMode) {
    CypressRunningMode["Console"] = "console";
    CypressRunningMode["Browser"] = "browser";
})(CypressRunningMode = exports.CypressRunningMode || (exports.CypressRunningMode = {}));
class CypressBuilder {
    constructor(context) {
        this.context = context;
    }
    run(builderConfig) {
        const options = Object.assign({}, builderConfig.options, { project: builderConfig.root });
        return rxjs_1.of(null).pipe(operators_1.concatMap(() => options.devServerTarget ? this._startDevServer(options) : rxjs_1.of(null)), operators_1.concatMap(() => this._execute(options)), operators_1.take(1));
    }
    // Note: this method mutates the options argument.
    _startDevServer(options) {
        const architect = this.context.architect;
        const [project, targetName, configuration] = options.devServerTarget.split(":");
        // use browser build watch setting based on cypress running mode
        const watchMode = options.mode === CypressRunningMode.Browser;
        const overrides = { watch: watchMode, host: options.host, port: options.port };
        const targetSpec = {
            project,
            target: targetName,
            configuration,
            overrides
        };
        const builderConfig = architect.getBuilderConfiguration(targetSpec);
        let devServerDescription;
        let baseUrl;
        return architect.getBuilderDescription(builderConfig).pipe(operators_1.tap(description => (devServerDescription = description)), operators_1.concatMap(description => architect.validateBuilderOptions(builderConfig, description)), operators_1.concatMap(() => {
            // Compute baseUrl from devServerOptions.
            if (options.devServerTarget && builderConfig.options.publicHost) {
                let publicHost = builderConfig.options.publicHost;
                if (!/^\w+:\/\//.test(publicHost)) {
                    publicHost = `${builderConfig.options.ssl ? "https" : "http"}://${publicHost}`;
                }
                const clientUrl = url.parse(publicHost);
                baseUrl = url.format(clientUrl);
            }
            else if (options.devServerTarget) {
                baseUrl = url.format({
                    protocol: builderConfig.options.ssl ? "https" : "http",
                    hostname: options.host,
                    port: builderConfig.options.port.toString()
                });
            }
            // Save the computed baseUrl back so that Protractor can use it.
            options.baseUrl = baseUrl;
            return rxjs_1.of(this.context.architect.getBuilder(devServerDescription, this.context));
        }), operators_1.concatMap(builder => builder.run(builderConfig)));
    }
    _execute(options) {
        const additionalCypressConfig = Object.assign({ config: {
                baseUrl: options.baseUrl
            } }, (options.ciBuildId ? { ciBuildId: options.ciBuildId } : {}), (options.env ? { env: options.env } : {}), (options.group ? { group: options.group } : {}), (options.key ? { key: options.key } : {}), (options.parallel ? { parallel: options.parallel } : {}), (options.project ? { project: options.project } : {}), (options.record ? { record: options.record } : {}), (options.reporter ? { reporter: options.reporter } : {}), (options.reporterPath ? { reporter: options.reporterPath } : {}), (options.spec ? { spec: options.spec } : {}));
        const cypress = require("cypress");
        const runner = options.mode === CypressRunningMode.Console
            ? rxjs_1.from(cypress.run(additionalCypressConfig))
                .pipe(operators_1.map((result) => ({ success: result.totalFailed === 0 })))
            : cypress.open(additionalCypressConfig);
        return rxjs_1.from(runner);
    }
}
exports.CypressBuilder = CypressBuilder;
exports.default = CypressBuilder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3lwcmVzcy1idWlsZGVyLmpzIiwic291cmNlUm9vdCI6Ii9Vc2Vycy9nb256YWxvaWduYWNpb3BpbmNoZWlyYWFyYW5jaWJpYS9EZXNrdG9wL25vZGVBcHBzL2dpdGh1Yi9uZ3gtY3lwcmVzcy1idWlsZGVyL2xpYi8iLCJzb3VyY2VzIjpbInNyYy9jeXByZXNzL2N5cHJlc3MtYnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQWNBLCtCQUE0QztBQUM1Qyw4Q0FBMkQ7QUFDM0QsMkJBQTJCO0FBRTNCLElBQVksa0JBR1g7QUFIRCxXQUFZLGtCQUFrQjtJQUM1Qix5Q0FBbUIsQ0FBQTtJQUNuQix5Q0FBbUIsQ0FBQTtBQUNyQixDQUFDLEVBSFcsa0JBQWtCLEdBQWxCLDBCQUFrQixLQUFsQiwwQkFBa0IsUUFHN0I7QUFvQkQ7SUFDRSxZQUFtQixPQUF1QjtRQUF2QixZQUFPLEdBQVAsT0FBTyxDQUFnQjtJQUFHLENBQUM7SUFFOUMsR0FBRyxDQUNELGFBQTBEO1FBRTFELE1BQU0sT0FBTyxxQkFDUixhQUFhLENBQUMsT0FBTyxJQUN4QixPQUFPLEVBQUUsYUFBYSxDQUFDLElBQUksR0FDNUIsQ0FBQztRQUVGLE9BQU8sU0FBRSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FDbEIscUJBQVMsQ0FDUCxHQUFHLEVBQUUsQ0FDSCxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFFLENBQUMsSUFBSSxDQUFDLENBQ3JFLEVBQ0QscUJBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQ3ZDLGdCQUFJLENBQUMsQ0FBQyxDQUFDLENBQ1IsQ0FBQztJQUNKLENBQUM7SUFFRCxrREFBa0Q7SUFDMUMsZUFBZSxDQUFDLE9BQThCO1FBQ3BELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMs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LEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQzNELENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFDekMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssRUFBRSxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUMvQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxFQUFFLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQ3pDLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFDeEQsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUNyRCxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQ2xELENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxRQUFRLEVBQUUsT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFDeEQsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLFFBQVEsRUFBRSxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUNoRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQ2hELENBQUM7UUFDRixNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbkMsTUFBTSxNQUFNLEdBQ1YsT0FBTyxDQUFDLElBQUksS0FBSyxrQkFBa0IsQ0FBQyxPQUFPO1lBQ3pDLENBQUMsQ0FBQyxXQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO2lCQUN2QyxJQUFJLENBQUMsZUFBRyxDQUFDLENBQUMsTUFBVyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsT0FBTyxFQUFFLE1BQU0sQ0FBQyxXQUFXLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3hFLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7UUFFNUMsT0FBTyxXQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBekdELHdDQXlHQztBQUVELGtCQUFlLGNBQWMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBAbGljZW5zZVxyXG4gKiBDb3B5cmlnaHQgR29vZ2xlIEluYy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cclxuICpcclxuICogVXNlIG9mIHRoaXMgc291cmNlIGNvZGUgaXMgZ292ZXJuZWQgYnkgYW4gTUlULXN0eWxlIGxpY2Vuc2UgdGhhdCBjYW4gYmVcclxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxyXG4gKi9cclxuaW1wb3J0IHtcclxuICBCdWlsZGVyLFxyXG4gIEJ1aWxkZXJDb25maWd1cmF0aW9uLFxyXG4gIEJ1aWxkZXJDb250ZXh0LFxyXG4gIEJ1aWxkZXJEZXNjcmlwdGlvbixcclxuICBCdWlsZEV2ZW50XHJcbn0gZnJvbSBcIkBhbmd1bGFyLWRldmtpdC9hcmNoaXRlY3RcIjtcclxuaW1wb3J0IHsgZnJvbSwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tIFwicnhqc1wiO1xyXG5pbXBvcnQgeyBjb25jYXRNYXAsIG1hcCwgdGFrZSwgdGFwIH0gZnJvbSBcInJ4anMvb3BlcmF0b3JzXCI7XHJcbmltcG9ydCAqIGFzIHVybCBmcm9tIFwidXJsXCI7XHJcblxyXG5leHBvcnQgZW51bSBDeXByZXNzUnVubmluZ01vZGUge1xyXG4gIENvbnNvbGUgPSBcImNvbnNvbGVcIixcclxuICBCcm93c2VyID0gXCJicm93c2VyXCJcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBDeXByZXNzQnVpbGRlck9wdGlvbnMge1xyXG4gIGRldlNlcnZlclRhcmdldD86IHN0cmluZztcclxuICBtb2RlPzogc3RyaW5nO1xyXG4gIGJhc2VVcmw/OiBzdHJpbmc7XHJcbiAgaG9zdD86IHN0cmluZztcclxuICBjaUJ1aWxkSWQ/OiBzdHJpbmc7XHJcbiAgZW52Pzogb2JqZWN0O1xyXG4gIGdyb3VwPzogc3RyaW5nO1xyXG4gIGtleT86IHN0cmluZztcclxuICBwYXJhbGxlbD86IGJvb2xlYW47XHJcbiAgcG9ydD86IG51bWJlcjtcclxuICBwcm9qZWN0Pzogc3RyaW5nO1xyXG4gIHJlY29yZD86IGJvb2xlYW47XHJcbiAgcmVwb3J0ZXI/OiBzdHJpbmc7XHJcbiAgcmVwb3J0ZXJQYXRoPzogc3RyaW5nO1xyXG4gIHNwZWM/OiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBDeXByZXNzQnVpbGRlciBpbXBsZW1lbnRzIEJ1aWxkZXI8Q3lwcmVzc0J1aWxkZXJPcHRpb25zPiB7XHJcbiAgY29uc3RydWN0b3IocHVibGljIGNvbnRleHQ6IEJ1aWxkZXJDb250ZXh0KSB7fVxyXG5cclxuICBydW4oXHJcbiAgICBidWlsZGVyQ29uZmlnOiBCdWlsZGVyQ29uZmlndXJhdGlvbjxDeXByZXNzQnVpbGRlck9wdGlvbnM+XHJcbiAgKTogT2JzZXJ2YWJsZTxCdWlsZEV2ZW50PiB7XHJcbiAgICBjb25zdCBvcHRpb25zID0ge1xyXG4gICAgICAuLi5idWlsZGVyQ29uZmlnLm9wdGlvbnMsXHJcbiAgICAgIHByb2plY3Q6IGJ1aWxkZXJDb25maWcucm9vdFxyXG4gICAgfTtcclxuXHJcbiAgICByZXR1cm4gb2YobnVsbCkucGlwZShcclxuICAgICAgY29uY2F0TWFwKFxyXG4gICAgICAgICgpID0+XHJcbiAgICAgICAgICBvcHRpb25zLmRldlNlcnZlclRhcmdldCA/IHRoaXMuX3N0YXJ0RGV2U2VydmVyKG9wdGlvbnMpIDogb2YobnVsbClcclxuICAgICAgKSxcclxuICAgICAgY29uY2F0TWFwKCgpID0+IHRoaXMuX2V4ZWN1dGUob3B0aW9ucykpLFxyXG4gICAgICB0YWtlKDEpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8gTm90ZTogdGhpcyBtZXRob2QgbXV0YXRlcyB0aGUgb3B0aW9ucyBhcmd1bWVudC5cclxuICBwcml2YXRlIF9zdGFydERldlNlcnZlcihvcHRpb25zOiBDeXByZXNzQnVpbGRlck9wdGlvbnMpIHtcclxuICAgIGNvbnN0IGFyY2hpdGVjdCA9IHRoaXMuY29udGV4dC5hcmNoaXRlY3Q7XHJcbiAgICBjb25zdCBbXHJcbiAgICAgIHByb2plY3QsXHJcbiAgICAgIHRhcmdldE5hbWUsXHJcbiAgICAgIGNvbmZpZ3VyYXRpb25cclxuICAgIF0gPSAob3B0aW9ucy5kZXZTZXJ2ZXJUYXJnZXQgYXMgc3RyaW5nKS5zcGxpdChcIjpcIik7XHJcbiAgICAvLyB1c2UgYnJvd3NlciBidWlsZCB3YXRjaCBzZXR0aW5nIGJhc2VkIG9uIGN5cHJlc3MgcnVubmluZyBtb2RlXHJcbiAgICBjb25zdCB3YXRjaE1vZGUgPSBvcHRpb25zLm1vZGUgPT09IEN5cHJlc3NSdW5uaW5nTW9kZS5Ccm93c2VyO1xyXG4gICAgY29uc3Qgb3ZlcnJpZGVzID0geyB3YXRjaDogd2F0Y2hNb2RlLCBob3N0OiBvcHRpb25zLmhvc3QsIHBvcnQ6IG9wdGlvbnMucG9ydCB9O1xyXG4gICAgY29uc3QgdGFyZ2V0U3BlYyA9IHtcclxuICAgICAgcHJvamVjdCxcclxuICAgICAgdGFyZ2V0OiB0YXJnZXROYW1lLFxyXG4gICAgICBjb25maWd1cmF0aW9uLFxyXG4gICAgICBvdmVycmlkZXNcclxuICAgIH07XHJcbiAgICBjb25zdCBidWlsZGVyQ29uZmlnID0gYXJjaGl0ZWN0LmdldEJ1aWxkZXJDb25maWd1cmF0aW9uPGFueT4odGFyZ2V0U3BlYyk7XHJcbiAgICBsZXQgZGV2U2VydmVyRGVzY3JpcHRpb246IEJ1aWxkZXJEZXNjcmlwdGlvbjtcclxuICAgIGxldCBiYXNlVXJsOiBzdHJpbmc7XHJcblxyXG4gICAgcmV0dXJuIGFyY2hpdGVjdC5nZXRCdWlsZGVyRGVzY3JpcHRpb24oYnVpbGRlckNvbmZpZykucGlwZShcclxuICAgICAgdGFwKFxyXG4gICAgICAgIGRlc2NyaXB0aW9uID0+XHJcbiAgICAgICAgICAoZGV2U2VydmVyRGVzY3JpcHRpb24gPSBkZXNjcmlwdGlvbiBhcyBCdWlsZGVyRGVzY3JpcHRpb24pXHJcbiAgICAgICksXHJcbiAgICAgIGNvbmNhdE1hcChkZXNjcmlwdGlvbiA9PlxyXG4gICAgICAgIGFyY2hpdGVjdC52YWxpZGF0ZUJ1aWxkZXJPcHRpb25zKGJ1aWxkZXJDb25maWcsIGRlc2NyaXB0aW9uKVxyXG4gICAgICApLFxyXG4gICAgICBjb25jYXRNYXAoKCkgPT4ge1xyXG4gICAgICAgIC8vIENvbXB1dGUgYmFzZVVybCBmcm9tIGRldlNlcnZlck9wdGlvbnMuXHJcbiAgICAgICAgaWYgKG9wdGlvbnMuZGV2U2VydmVyVGFyZ2V0ICYmIGJ1aWxkZXJDb25maWcub3B0aW9ucy5wdWJsaWNIb3N0KSB7XHJcbiAgICAgICAgICBsZXQgcHVibGljSG9zdCA9IGJ1aWxkZXJDb25maWcub3B0aW9ucy5wdWJsaWNIb3N0O1xyXG4gICAgICAgICAgaWYgKCEvXlxcdys6XFwvXFwvLy50ZXN0KHB1YmxpY0hvc3QpKSB7XHJcbiAgICAgICAgICAgIHB1YmxpY0hvc3QgPSBgJHtcclxuICAgICAgICAgICAgICBidWlsZGVyQ29uZmlnLm9wdGlvbnMuc3NsID8gXCJodHRwc1wiIDogXCJodHRwXCJcclxuICAgICAgICAgICAgfTovLyR7cHVibGljSG9zdH1gO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgY29uc3QgY2xpZW50VXJsID0gdXJsLnBhcnNlKHB1YmxpY0hvc3QpO1xyXG4gICAgICAgICAgYmFzZVVybCA9IHVybC5mb3JtYXQoY2xpZW50VXJsKTtcclxuICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuZGV2U2VydmVyVGFyZ2V0KSB7XHJcbiAgICAgICAgICBiYXNlVXJsID0gdXJsLmZvcm1hdCh7XHJcbiAgICAgICAgICAgIHByb3RvY29sOiBidWlsZGVyQ29uZmlnLm9wdGlvbnMuc3NsID8gXCJodHRwc1wiIDogXCJodHRwXCIsXHJcbiAgICAgICAgICAgIGhvc3RuYW1lOiBvcHRpb25zLmhvc3QsXHJcbiAgICAgICAgICAgIHBvcnQ6IGJ1aWxkZXJDb25maWcub3B0aW9ucy5wb3J0LnRvU3RyaW5nKClcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gU2F2ZSB0aGUgY29tcHV0ZWQgYmFzZVVybCBiYWNrIHNvIHRoYXQgUHJvdHJhY3RvciBjYW4gdXNlIGl0LlxyXG4gICAgICAgIG9wdGlvbnMuYmFzZVVybCA9IGJhc2VVcmw7XHJcblxyXG4gICAgICAgIHJldHVybiBvZihcclxuICAgICAgICAgIHRoaXMuY29udGV4dC5hcmNoaXRlY3QuZ2V0QnVpbGRlcihkZXZTZXJ2ZXJEZXNjcmlwdGlvbiwgdGhpcy5jb250ZXh0KVxyXG4gICAgICAgICk7XHJcbiAgICAgIH0pLFxyXG4gICAgICBjb25jYXRNYXAoYnVpbGRlciA9PiBidWlsZGVyLnJ1bihidWlsZGVyQ29uZmlnKSlcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9leGVjdXRlKG9wdGlvbnM6IEN5cHJlc3NCdWlsZGVyT3B0aW9ucyk6IE9ic2VydmFibGU8QnVpbGRFdmVudD4ge1xyXG4gICAgY29uc3QgYWRkaXRpb25hbEN5cHJlc3NDb25maWcgPSB7XHJcbiAgICAgIGNvbmZpZzoge1xyXG4gICAgICAgIGJhc2VVcmw6IG9wdGlvbnMuYmFzZVVybFxyXG4gICAgICB9LFxyXG4gICAgICAuLi4ob3B0aW9ucy5jaUJ1aWxkSWQgPyB7IGNpQnVpbGRJZDogb3B0aW9ucy5jaUJ1aWxkSWQgfSA6IHt9KSxcclxuICAgICAgLi4uKG9wdGlvbnMuZW52ID8geyBlbnY6IG9wdGlvbnMuZW52IH0gOiB7fSksXHJcbiAgICAgIC4uLihvcHRpb25zLmdyb3VwID8geyBncm91cDogb3B0aW9ucy5ncm91cCB9IDoge30pLFxyXG4gICAgICAuLi4ob3B0aW9ucy5rZXkgPyB7IGtleTogb3B0aW9ucy5rZXkgfSA6IHt9KSxcclxuICAgICAgLi4uKG9wdGlvbnMucGFyYWxsZWwgPyB7IHBhcmFsbGVsOiBvcHRpb25zLnBhcmFsbGVsIH0gOiB7fSksXHJcbiAgICAgIC4uLihvcHRpb25zLnByb2plY3QgPyB7IHByb2plY3Q6IG9wdGlvbnMucHJvamVjdCB9IDoge30pLFxyXG4gICAgICAuLi4ob3B0aW9ucy5yZWNvcmQgPyB7IHJlY29yZDogb3B0aW9ucy5yZWNvcmQgfSA6IHt9KSxcclxuICAgICAgLi4uKG9wdGlvbnMucmVwb3J0ZXIgPyB7IHJlcG9ydGVyOiBvcHRpb25zLnJlcG9ydGVyIH0gOiB7fSksXHJcbiAgICAgIC4uLihvcHRpb25zLnJlcG9ydGVyUGF0aCA/IHsgcmVwb3J0ZXI6IG9wdGlvbnMucmVwb3J0ZXJQYXRoIH0gOiB7fSksXHJcbiAgICAgIC4uLihvcHRpb25zLnNwZWMgPyB7IHNwZWM6IG9wdGlvbnMuc3BlYyB9IDoge30pXHJcbiAgICB9O1xyXG4gICAgY29uc3QgY3lwcmVzcyA9IHJlcXVpcmUoXCJjeXByZXNzXCIpO1xyXG4gICAgY29uc3QgcnVubmVyID1cclxuICAgICAgb3B0aW9ucy5tb2RlID09PSBDeXByZXNzUnVubmluZ01vZGUuQ29uc29sZVxyXG4gICAgICAgID8gZnJvbShjeXByZXNzLnJ1bihhZGRpdGlvbmFsQ3lwcmVzc0NvbmZpZykpXHJcbiAgICAgICAgICAgIC5waXBlKG1hcCgocmVzdWx0OiBhbnkpID0+ICh7IHN1Y2Nlc3M6IHJlc3VsdC50b3RhbEZhaWxlZCA9PT0gMCB9KSkpXHJcbiAgICAgICAgOiBjeXByZXNzLm9wZW4oYWRkaXRpb25hbEN5cHJlc3NDb25maWcpO1xyXG5cclxuICAgIHJldHVybiBmcm9tKHJ1bm5lcik7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBDeXByZXNzQnVpbGRlcjtcclxuIl19